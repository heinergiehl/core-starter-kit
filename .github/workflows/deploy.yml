name: Deploy Shipsolid

on:
  push:
    branches: [master, main]

jobs:
  # ----------------------------------------------------------------------
  # 1. CI: Test Build & Integrity with Postgres
  # ----------------------------------------------------------------------
  ci:
    name: CI Check
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: laravel
          POSTGRES_USER: root
          POSTGRES_PASSWORD: password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, bcmath, intl, pdo_pgsql, pgsql, dom, fileinfo
          coverage: none

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.12.0'
          cache: npm

      - name: Install Composer Dependencies
        run: composer install --no-dev --prefer-dist --optimize-autoloader

      - name: Generate App Key
        run: php -r "file_exists('.env') || copy('.env.example', '.env');" && php artisan key:generate

      - name: Install NPM Dependencies & Build
        run: |
          npm ci
          npm run build

      - name: Run Tests
        env:
          DB_CONNECTION: pgsql
          DB_HOST: 127.0.0.1
          DB_PORT: 5432
          DB_DATABASE: laravel
          DB_USERNAME: root
          DB_PASSWORD: password
        run: php artisan test

  # ----------------------------------------------------------------------
  # 2. CD: Deploy to Hostinger VPS
  # ----------------------------------------------------------------------
  deploy:
    name: Deploy to VPS
    needs: ci
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Prepare Remote Directory
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "mkdir -p /var/www/myapps/shipsolid && chown -R ${{ secrets.VPS_USER }}:${{ secrets.VPS_USER }} /var/www/myapps/shipsolid"

      - name: Sync Files to VPS
        # Excludes .git, node_modules (we build on server to match env), storage (linked)
        run: |
          rsync -az --delete --exclude='.git' --exclude='node_modules' --exclude='storage' --exclude='.env' ./ \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/var/www/myapps/shipsolid

      - name: Upload Production .env
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
          "printf '%s\n' '${{ secrets.PROD_ENV_FILE }}' > /var/www/myapps/shipsolid/.env"

      - name: Execute Remote Deploy Commands
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} <<'EOF'
            set -e
            cd /var/www/myapps/shipsolid

            # 1. Install Dependencies
            composer install --no-dev --optimize-autoloader --no-interaction
            npm ci
            
            # 2. Build Assets
            npm run build

            # 3. Framework Maintenance
            php artisan down --render="errors::503"
            
            # Ensure storage linking if not exists
            php artisan storage:link
            
            # Database & Caches
            php artisan migrate --force
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan event:cache
            
            # Filament specific
            php artisan filament:upgrade
            php artisan filament:optimize-clear

            php artisan up

            # 4. Reload Services
            sudo systemctl reload php8.2-fpm
            echo "Deployment finished successfully."
          EOF

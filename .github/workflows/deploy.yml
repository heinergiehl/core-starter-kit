name: Deploy Shipsolid

on:
  workflow_run:
    workflows: ["CI"]
    branches: [main]
    types: [completed]
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref (branch, tag, or SHA) to deploy to production"
        required: false
        default: "main"

concurrency:
  group: shipsolid-deploy-${{ github.event_name == 'workflow_run' && 'staging' || 'production' }}
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to ${{ github.event_name == 'workflow_run' && 'Staging' || 'Production' }}
    if: ${{ (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'push') || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'workflow_run' && 'staging' || 'production' }}

    env:
      DEPLOY_ENV: ${{ github.event_name == 'workflow_run' && 'staging' || 'production' }}
      DEPLOY_REF: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.event.inputs.ref || 'main' }}
      PADDLE_ENV_DEFAULT: ${{ github.event_name == 'workflow_run' && 'sandbox' || 'production' }}
      VPS_PATH: ${{ vars.VPS_PATH || (github.event_name == 'workflow_run' && '/var/www/myapps/shipsolid-staging' || '/var/www/myapps/shipsolid') }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEPLOY_REF }}

      - name: Deploy context
        run: |
          echo "Deploy environment: $DEPLOY_ENV"
          echo "Deploy ref: $DEPLOY_REF"

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: mbstring, bcmath, intl, pdo_pgsql, pgsql, dom, fileinfo

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22.12.0"
          cache: npm

      - name: Install PHP dependencies
        run: composer install --no-interaction --no-progress --prefer-dist --optimize-autoloader --no-dev --no-scripts

      - name: Install frontend dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add VPS to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Prepare Remote Directory
        run: |
          ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "mkdir -p '${VPS_PATH}'"

      - name: Sync
        run: |
          rsync -avz --delete \
            --exclude='.git/' \
            --exclude='.github/' \
            --exclude='.env' \
            --exclude='node_modules/' \
            --exclude='storage/' \
            --exclude='tests/' \
            --exclude='phpunit.xml' \
            ./ ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ env.VPS_PATH }}

      - name: Generate .env
        env:
          ENV_FILE: |
            APP_NAME="Matador"
            APP_ENV=${{ env.DEPLOY_ENV }}
            APP_KEY=${{ secrets.APP_KEY }}
            APP_DEBUG=false
            APP_URL=${{ secrets.APP_URL }}
            
            APP_LOCALE=en
            APP_FALLBACK_LOCALE=en
            APP_FAKER_LOCALE=en_US
            
            APP_MAINTENANCE_DRIVER=file
            BCRYPT_ROUNDS=12
            
            LOG_CHANNEL=stack
            LOG_STACK=single
            LOG_LEVEL=${{ env.DEPLOY_ENV == 'staging' && 'debug' || 'info' }}
            
            DB_CONNECTION=pgsql
            DB_HOST=${{ secrets.DB_HOST || '172.17.0.1' }}
            DB_PORT=5432
            DB_DATABASE=${{ secrets.DB_DATABASE || 'laravel' }}
            DB_USERNAME=${{ secrets.DB_USERNAME || 'root' }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD || 'secret' }}
            
            SESSION_DRIVER=database
            SESSION_LIFETIME=120
            SESSION_ENCRYPT=false
            SESSION_PATH=/
            SESSION_DOMAIN=null
            
            BROADCAST_CONNECTION=log
            FILESYSTEM_DISK=public
            QUEUE_CONNECTION=database
            DB_QUEUE_RETRY_AFTER=120
            
            CACHE_STORE=database
            
            MEMCACHED_HOST=127.0.0.1
            REDIS_CLIENT=phpredis
            REDIS_HOST=127.0.0.1
            REDIS_PASSWORD=null
            REDIS_PORT=6379
            
            MAIL_MAILER=smtp
            MAIL_HOST=${{ secrets.MAIL_HOST || '127.0.0.1' }}
            MAIL_PORT=${{ secrets.MAIL_PORT || '1025' }}
            MAIL_USERNAME=${{ secrets.MAIL_USERNAME || 'null' }}
            MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD || 'null' }}
            MAIL_FROM_ADDRESS="${{ secrets.MAIL_FROM_ADDRESS || 'hello@example.com' }}"
            MAIL_FROM_NAME="${APP_NAME}"
            
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            
            GITHUB_CLIENT_ID=${{ secrets.GITHUB_CLIENT_ID }}
            GITHUB_CLIENT_SECRET=${{ secrets.GITHUB_CLIENT_SECRET }}
            
            VITE_APP_NAME="${APP_NAME}"
            
            BILLING_CATALOG=database
            BILLING_CATALOG_CONFIG=billing-catalog
            BILLING_CATALOG_REQUIRE_METADATA=true
            BILLING_CANCEL_URL=${{ secrets.APP_URL }}/pricing
            
            STRIPE_KEY=${{ secrets.STRIPE_KEY }}
            STRIPE_SECRET=${{ secrets.STRIPE_SECRET }}
            STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}
            
            PADDLE_VENDOR_ID=${{ secrets.PADDLE_VENDOR_ID }}
            PADDLE_API_KEY=${{ secrets.PADDLE_API_KEY }}
            PADDLE_WEBHOOK_SECRET=${{ secrets.PADDLE_WEBHOOK_SECRET }}
            PADDLE_ENV=${{ secrets.PADDLE_ENV || env.PADDLE_ENV_DEFAULT }}
            
            BRAND_FONT_SANS="Instrument Sans"
            BRAND_FONT_DISPLAY="Instrument Serif"
            BRAND_COLOR_PRIMARY="14 116 144"
            BRAND_COLOR_SECONDARY="245 158 11"
            BRAND_COLOR_ACCENT="239 68 68"
            BRAND_COLOR_BG="250 250 249"
            BRAND_COLOR_FG="15 23 42"
        run: |
          printf "%s" "$ENV_FILE" | ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "cat > ${{ env.VPS_PATH }}/.env"

      - name: Run Remote Scripts
        run: |
          ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
            set -e
            cd ${{ env.VPS_PATH }}
            
            # Ensure Postgres is running - ignore if already up/bound
            docker compose up -d --wait pgsql || true
            
            # Ensure storage structure exists since we exclude it from sync
            mkdir -p storage/framework/{cache,sessions,testing,views}
            mkdir -p storage/logs
            mkdir -p bootstrap/cache
            
            # Fix permissions
            chmod -R 775 storage bootstrap/cache

            php artisan storage:link --force
            php artisan down || true
            php artisan migrate --force
            php artisan filament:upgrade
            php artisan optimize
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan up
          EOF
